---
title: "Derivation of Typical Assemblages"
author: "Jonathan Jupke"
date: '`r gsub(pattern="k", replacement="c", x=gsub("^0", "", format(Sys.time(), "%B %d, %Y")), )`'
linestretch: 1.2
colorlinks: true
output:
  bookdown::pdf_document2:
    latex_engine: pdflatex
    number_sections: yes
    toc: no
    includes: 
        
        in_header: ../template/header.tex
bibliography: ../bib/ref.bib
csl: ../bib/ecology_letters.csl
mainfont: Times New Roman
sansfont: Times New Roman
fontsize: 12pt
link-citations: true
documentclass: article
geometry: margin=1in
always_allow_html: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# set to TRUE if you want to speed up computation 
knitr::opts_chunk$set(cache = FALSE,fig.pos = 'H',fig_cap=TRUE)

pacman::p_load(
  ape,
  cowplot,
  data.table,
  dplyr,
  fuzzySim,
  ggplot2,
  here,
  kableExtra,
  knitr,
  magrittr,
  stringr,
  vegan,
  viridis
)

dir_plots = "~/01_Uni/02_getreal/005_documents/plot_scripts/"
dir_sa_inv = "~/01_Uni/02_getreal/002_working_package_02/003_seasonality/003_results/invertebrates/"
dir_sa_dia = "~/01_Uni/02_getreal/002_working_package_02/003_seasonality/003_results/diatoms/"
```

\renewcommand{\baselinestretch}{0.5}\normalsize
\tableofcontents
\renewcommand{\baselinestretch}{1.1}\normalsize

\clearpage
# Introduction 
In GetReal, we investigate whether selected freshwater and terrestrial assemblages vary spatially and seasonally in their sensitivity towards chemicals and draw conclusions for risk assessment.
After we agreed on using the Pan-European river typology proposed by @LycheSolheim2019 to delineate the receiving freshwater systems, the next step was to derive their typical assemblages (TA). 
Here we describe the methods we used to derive TAs of macroinvertebrates and diatoms for selected river types across Europe. We also describe and briefly discuss the results.

# Harmonizing taxa names
International diatom occurrence datasets require extensive harmonization because of the taxonomic resolution differing between datasets, different working groups using different nomenclatures, identification errors, and ongoing changes to the accepted nomenclature [@Kahlert2020]. Though harmonizing occurrence datasets can reduce their taxonomic resolution, it also facilitates the detection of large-scale spatio-temporal patterns [@Lee2019]. We compared all our datasets against six databases that contain accepted names, synonyms with links to the respective accepted names, and suggestions for grouping contentious taxa in larger complexes. If we found a taxon name in one of the databases we either accepted it, changed it into the accepted name in case of a synonym, or included it in a complex. We did not query taxa we found in earlier databases against later ones, but in case the name changed from the original one, we queried the new one against earlier databases.
Lastly, we controlled the results visually for consistency. We used the following databases in the same order: 

1.	Table S2 from @Kahlert2020
2.	The taxon list associated with the OMNIDA software [@lecointe1993omnidia]
3.	The German list of freshwater organisms [@Mauch2017]
4.	The diat.barcode database [@Rimet2019]
5.	The website algaebase.org [@guiry2020]
6.	The global biodiversity information platform (gbif) [@gbif2020]

We harmonized the macroinvertebrate data with gbif through the taxize R package [@Chamberlain13]. 

# What is the optimal taxonomic level? 
One result of the second progress review for GetReal (29.04.2020) was that we should determine an optimal taxonomic level for each taxon separately instead of using one common level for all data. 
*Oligochaetes*, for example, are usually only determined to subclass level. 
In a setting with one common taxonomic level (e.g. genus) they would have to be omitted if this level would be higher than subclass. 
By using taxon-specific levels that take low-resolved taxa into account, we can thus use more of the data.
However this poses the challenge of finding an optimal level for each taxon given a dataset.  
The following refers exclusively to the macroinvertebrate data, as the taxonomic resolution was not an issue with diatom datasets. 
We describe the procedure for diatom data at the end of the section. 
The optimal level was established with a hierarchical approach. 
First, we removed all observations from Phyla and Classes that were not present in all datasets. 
We assumed that these represented differences in sampling rather than in communities. 
The classes Clitellata (Annelida), Insecta, Malacostraca (Arthropoda), Bivalvia and Gastropoda (Mollusca) remained.
In the following, a higher taxonomic level refers to levels with higher resolution, i.e. species is the highest taxonomic level and kingdom the lowest. 
For each taxon, we calculated the percentage of observations represented at each higher level. 
For example, 4.12% of observations from the order *Lepidoptera* are at the species level, 74.77% at the genus level, 7.75% at the family level, and 13.35% at the order level. 
Now given a threshold X, we hold a taxon to be optimally represented at a certain taxonomic level if less than X% are represented by higher levels. 
For example, *Lepidoptera* would be represented on order level if X > 4.12% + 74.77% + 7.75% = 86.64%. 
As there are no theoretical grounds on which to base such a threshold value we searched for noticeable patterns in the data (Figure  \@ref(fig:mzb-thresh-plot)). 
The most salient change occurs between 85% and 86%. 
It occurs because for X > 86% *Chironomidae* are represented at the family level. 
We used 85% as threshold. 
Observations that were missed by this procedure, e.g. observations of *Chironomidae* at the family level, were included at their respective level.   

```{r mzb-thresh-plot, echo=FALSE, fig.align="center", fig.height=3, fig.cap="Effect of the treshold value on (A) total observations of each taxonomic level and (B) percentage of each taxonomic level."}
source(file.path(dir_plots, "mzb_threshold.R"))
plot_thresh
```

For the diatoms, we employed 75\% as a threshold, because for *Gomphonema*, which is the fourth most common genus in our dataset, 81.43\% of the observations were at the species level. 
The taxonomic resolution was higher than in the macroinvertebrate data and the lowest resolution is the genus level. 
The equivalent of Figure \@ref(fig:mzb-thresh-plot) for diatoms can be found [here](https://github.com/JonJup/GetReal/tree/master/002_working_package_02/001_community_data/002_combined/001_diatoms/004_plots/threshold_plot).

# Can we represent the stream types with our data? 

We determined visually whether our dataset contained enough sampling sites in a given river type to derive meaningful TAs. 
The degree of representation for river types was graded in a three-tier system: high, medium, and low. 
A high degree of representation indicates, that we have many sampling locations, which are distributed across the instances of a river type that fall within the countries considered in GetReal. 
A low degree indicates the opposite, i.e. few and spatially clustered sites. 
A medium rating implies that we either have many sampling sites, but these only extend over parts of the countries or few sites that extend over most of the countries. 
The ratings for all river types for macroinvertebrates and diatoms are shown in table \@ref(tab:tbl-rating).  

```{r tbl-rating, echo=FALSE}
data <- data.frame("Rating"=rep(c("high", "medium", "low"), each=2),
                   "Taxon"=rep(c("macroinvertebrates","diatoms"), times = 3),
                   "River Types"=c(c("4, 5, 9, 10, 11, 12, 13, 16"), 
                                   c(""), 
                                   c("1, 2, 3, 8, 14, 15, 18"), 
                                   c("1, 2, 3, 4, 5, 6, 8, 9, 12, 14, 16, 17, 18, 19"), 
                                   c("6, 7, 17, 19, 20" ),
                                   c("7, 10, 11, 13, 15, 20")
                                   )
)
data %>%
  kable(caption = "The ratings for all river types for macroinvertebrates and diatoms") %>%
  kable_minimal() %>% 
  kable_styling(latex_options = "hold_position")
rm(data)
```

For each river type we provide maps with the associated sampling sites for [macroinvertebrates](https://github.com/JonJup/GetReal/tree/master/002_working_package_02/001_community_data/002_combined/002_invertebrates/004_plots/01_sampling_site_maps) and for [diatoms](https://github.com/JonJup/GetReal/tree/master/002_working_package_02/001_community_data/002_combined/001_diatoms/004_plots/sampling_maps).  
Further analyses were conducted for all stream types with a high or medium degree of representation. 
More information on the river types is available in @LycheSolheim2019. 
We have fewer sampling sites for diatoms than for macroinvertebrates which entails that the representation of stream types is mostly lower. 

# What is a typical assemblage? 

We derived typical assemblages using the commonness of each taxon in a respective river type. 
Here, the commonness of a taxon refers to the fraction of sampling sites in a river type where that taxon is found.
This is conceptually equal to the $B$ parameter used in the Species Indicator Value [@Caceres2009; @Dufrene1997]. 
We also considered the second parameter of that statistic, the specificity $A$ which refers to the fraction of occurrences of a taxon that fall within one river type. 
For example, $A=1$ indicates that all observations of taxon $x$ occurred in river type $y$ and hence that this taxon is highly specific to the given river type. 
A commonness of 1 shows that a taxon is present in every sample taken within a river type and therefore that it is very typical for that river type. 
A taxon belongs to the TA of a river type if it is more common that some threshold, which depends on the taxonomic level of the taxon, or if it is more specific than another treshold, which also depends on the taxonomic level. 
The B-threshold for species is 0.25, for genera 0.35 and for family or lower resolutions 0.55. 
In addition to the typical assemblages we also derived lists of specific taxa. 
To be included in these the specificity had to be above 0.9 for a species, 0.8 for genus or 0.7 for family or lower taxonomic levels. 

We did not systematically optimize these thresholds. 
Such procedures would require optimization criteria, but we are not aware of any criterion that would work in this context. 
As TAs can be very similar in composition or harbor strongly differing numbers of taxa, neither criterion would optimize what we would consider a TA.
We think the use of subjectively defined thresholds is justified, as long as they are clearly and openly communicated, to be what we define as “typical" assemblages. 

However, we conducted a sensitivity analysis to see how varying these parameters would alter the results. 
We derived TAs for 50 values of **A** and **B** ranging from 0.01 to 1 and computed taxon richness and uniqueness scores (see Figure \@ref(fig:plot-uni) and text preceding the Figure) of each TA. 
Please note that results are only shown and discussed for the non-redundant TAs (see section \@ref(sec:redundancy)).   

```{r load-sa-plots, results='hide', echo=FALSE, message=FALSE, warning=FALSE}
source(file.path(dir_plots, "mzb_sensitivity_analysis.R"))
source(file.path(dir_plots, "dia_sensitivity_analysis.R"))
```

```{r plot-sa-mzb, echo=FALSE, fig.align="center",fig.height=5, fig.width=6,fig.cap="Changes in richness along gradients of A and B thresholds in macroinvertebrates (A, B) and diatoms (C, D). The line color indicates the river type."}
plot_grid(ggrid_rich_mzb, ggrid_rich_dia, ncol = 1)
```
```{r metrics-sa, results='hide', echo=FALSE}
dt_min_b <- dt_mzb_b[u_all == 0, min(threshold),by=river_type] 
mzb_min_rt = dt_min_b[V1 == min(V1), river_type]
mzb_min_b  = dt_min_b[V1 == min(V1), V1]
mzb_min_max_rt = dt_min_b[V1 == max(V1), river_type]
mzb_min_max_b  = dt_min_b[V1 == max(V1), V1]
dt_dia_min_b   = dt_dia_b[u_all == 0, min(threshold), by=river_type]
dia_min_rt     = dt_dia_min_b[V1 == min(V1), river_type]
dia_min_b      = dt_dia_min_b[V1 == min(V1), V1]
dia_at1        = dt_dia_min_b[V1 == 1, as.character(river_type)]
dia_at1        = paste(dia_at1, collapse = ", ")
```

Richness decreased with increasing **A** and **B** threshold in macroinvertebrates and diatoms (Figure \@ref(fig:plot-sa-mzb)).
Uniqueness scores increased with **A** thresholds up to a certain level and then decreased (Figure \@ref(fig:plot-sa-dia)). 
There is considerable variation between river types as to where this inflection occurs. 
Along the B-gradient, uniqueness score fluctuate erratically, driven by the relative rate at which other river types loose taxa and the identity of these. 
At some point no taxa are common enough to surpass the set B-threshold and the TAs are empty. 
For macroinvertebrates this takes place for B values between `r mzb_min_b` (`r mzb_min_rt`) and `r mzb_min_max_b` (`r mzb_min_max_rt`).
In the diatom assemblages this occurs later (at B = `r dia_min_b` in `r dia_min_rt`) and not at all in `r dia_at1`. 
This highlights that there must be several widely distributed diatom taxa, which is likely to some degree also the result of our extensive harmonization efforts. 

Plots for each taxon level separately are available for [macroinvertebrates](https://github.com/JonJup/GetReal/tree/master/002_working_package_02/001_community_data/002_combined/002_invertebrates/004_plots/02_sensitivity_analysis) and [diatoms](https://github.com/JonJup/GetReal/tree/master/002_working_package_02/001_community_data/002_combined/001_diatoms/004_plots/sensitivity%20analysis). 
However, the general patterns visible in Figure \@ref(fig:plot-sa-mzb) and \@ref(fig:plot-sa-dia), hold for them as well. 

```{r plot-sa-dia, echo=FALSE, fig.align="center",fig.height=5, fig.width=6,fig.cap="Changes in uniqueness scores along gradients of A and B thresholds in macroinvertebrates (A, B) and diatoms (C, D). The line color indicates the river type."}
plot_grid(ggrid_uniq_mzb, ggrid_uniq_dia, ncol = 1)
```

# Redundancy between typical assemblages {#sec:redundancy}

We assessed the degree to which the different TAs overlap. 
The degree of overlap is the percentage of taxa in a TA that is also present in the most similar (largest overlap) TA. 
Again, choosing a threshold above which we consider two assemblages to be redundant is somewhat arbitrary. 
We proceeded with 75% but are open to other suggestions. 
After assessing the redundancy we joined the two river types with the highest redundancy, if that redundancy was above 0.8, and computed the new TAs. 
This procedure was iterated until no redundancies were above 0.8.
In macroinvertebrates, we combined RT2 and 3, RT 4 and 5 and RT 8,9,10,11,15 and 16. 
RT2 and 3 are both lowland, siliceous rivers of medium to large (RT2) or very small to small (RT3) size. 
Their combination is plausible resulting in very small to large lowland siliceous rivers. 
Note that very large rivers (catchment area > 10.000 km$^2$) are a separate type (RT1). 
RT4 and 5 follow the same logic as RT2 and 3. 
They are lowland calcareous or mixed rivers of of medium to large (RT4) or very small to small (RT5) size.
The larger cluster of RT 8,9,10,11,15, and 16 is driven by altitude. 
The river types 8 to 11 are mid-altitude (200 - 800 m.a.s.l.) rivers differing in size and geology. 
There are three mid-altitude river types that did not fall into this cluster: RT12 which represents siliceous rivers with histosol soils in more than 20% of the catchment area, RT13 which is exceedingly rare and was omitted from the analysis, and RT18 which delineates Mediterranean mid-altitude rivers. 
The two river types RT15 and RT16 are two of three types of high altitude ($>$ 800 m.a.s.l.) rivers. 
Both occur mainly in southern Europe with differentiates them from the northern high altitude rivers in RT14.  
In summary this large cluster represents mid- to high-altitude rivers of various sizes and geologies.    

In diatoms,  the river types 1, 2, 4, 8, 9, 17, 18, and 19 are all combined into one large cluster.
This cluster comprises large (RT2 and RT4) to very large (RT1) lowland rivers, all three types perennial Mediterranean rivers  (RT 17, 18 and 19) as well as some mid-altitude rivers (RT8 and RT9). 
This collection seems eclectic and might indicate a dominance of widespread generalist species. 
Hence it is more informative to focus on what is not comprised in it.  
Small lowland rivers (RT3 and RT5) have distinct typical TAs from their larger counterparts and from each other. 
The two river types that are characterized by histosol soils (RT6 and RT12), are most similar to one another (55.2% and 51.6%) but their overlap is the lowest we observed in diatoms. 
Previous studies indicated, that there is strong turnover in diatom communities along organic matter gradients  [@Kelly1995;@coring1999situation; @Hering2006].
Lastly, high altitude rivers (RT16) seem to be different from the large cluster despite a considerable spatial proximity to many sites in the latter. 
@Wang2019 recently showed that altitude affects assembly processes and community composition in diatoms and @Gothe2013 found similar patterns. 

# Characteristics of typical assemblages

```{r load-mzb-n-taxa, echo=F, results='hide', warning=FALSE, message=FALSE}
source(file.path(dir_plots, "mzb_taxon_level_frequencies.R"))
source(file.path(dir_plots, "dia_taxon_level_frequencies.R"))
```

```{r metrics character, echo=F, results='hide'}
## -- mean number of taxa -- ## 
dt_acp_dia_mean         = dt_acp_dia[, mean(value), by = variable]
dt_acp_dia_mean_species = round(dt_acp_dia_mean[variable == "species", V1],2)
dt_acp_dia_mean_genus   = round(dt_acp_dia_mean[variable == "genus", V1],2)

dt_acp_mzb_mean         = dt_acp_mzb[, mean(value, na.rm = T), by = variable]
dt_acp_mzb_mean_species = round(dt_acp_mzb_mean[variable == "species", V1],2)
dt_acp_mzb_mean_genus   = round(dt_acp_mzb_mean[variable == "genus", V1],2)
dt_acp_mzb_mean_fol     = round(dt_acp_mzb_mean[variable == "fol", V1],2     )

# -- smallest and largest river types -- #
dt_acp_dia_species = dt_acp_dia[variable == "species"] 
dt_acp_dia_genus   = dt_acp_dia[variable == "genus"]
dt_acp_dia_join    = dt_acp_dia_species[dt_acp_dia_genus, on = "river_type"]
dt_acp_dia_join[, total := value + i.value]
dia_min_rt = paste0("RT", dt_acp_dia_join[total == min(total), river_type])
dia_min_in = dt_acp_dia_join[total == min(total), total]
dia_max_rt = paste0("RT", dt_acp_dia_join[total == max(total), river_type])
dia_max_in = dt_acp_dia_join[total == max(total), total]

dt_acp_mzb_species = dt_acp_mzb[variable == "species"]
dt_acp_mzb_species[is.na(value), value := 0]
dt_acp_mzb_genus   = dt_acp_mzb[variable == "genus"]
dt_acp_mzb_fol     = dt_acp_mzb[variable == "fol"]
dt_acp_mzb_join    = dt_acp_mzb_species[dt_acp_mzb_genus[dt_acp_mzb_fol, on = "river_type"], on = "river_type"]
dt_acp_mzb_join[, total := value + i.value + i.value.1]
mzb_min_rt = paste0("RT", dt_acp_mzb_join[total == min(total), river_type])
if (length(mzb_min_rt) == 1) mzb_min_rt=paste(mzb_min_rt, "had the least taxa")
if (length(mzb_min_rt) > 1)  {
  mzb_min_rt %<>% paste(collapse = " and ")
  mzb_min_rt %<>% paste("had the least taxa")
}
mzb_max_rt = paste0("RT", dt_acp_mzb_join[total == max(total), river_type])
if (length(mzb_max_rt) == 1) mzb_max_rt=paste0(mzb_max_rt, " was the most taxa rich assemblage")
if (length(mzb_max_rt) > 1)  {
  mzb_max_rt %<>% paste(collapse = " and ")
  mzb_max_rt %<>% paste(" were the most taxa rich assemblages")
}

mzb_max_in = dt_acp_mzb_join[total == max(total), total]
mzb_min_in = dt_acp_mzb_join[total == min(total), total]

mzb_min_in = ifelse(length(mzb_min_in)==1,mzb_min_in,unique(mzb_min_in))
mzb_max_in = ifelse(length(mzb_max_in)==1,mzb_max_in,unique(mzb_max_in))

```

In all macroinvertebrate TAs, except RT14, genus is the prevalent taxonomic level, followed by families or lower taxonomic levels and lastly species (Figure \@ref(fig:plot-mzb-n-taxa)A). 
The mean number of species was `r dt_acp_mzb_mean_species`, mean number of genera `r dt_acp_mzb_mean_genus`, and the mean number of families or lower `r dt_acp_mzb_mean_fol`.
`r mzb_min_rt`  with `r mzb_min_in` taxa and `r mzb_max_rt`  with `r mzb_max_in` taxa. 
For diatoms, species is the prevalent taxonomic level in all TAs (Figure \@ref(fig:plot-mzb-n-taxa)B). 
The mean number of species per TA is `r dt_acp_dia_mean_species`  and the mean number of genera `r dt_acp_dia_mean_genus`. 
`r dia_max_rt` has the most taxa rich TA with `r dia_max_in` taxa and `r dia_min_rt` has the least taxa in its TA with `r dia_min_in`. 
Note that RT3 or a combined river type including it (RT2_3) had the most taxa rich TA for both taxa and that diatom TAs encompass more taxa than macroinvertebrate TAs which supports the trends from the sensitivity analysis (Figure \@ref(fig:plot-sa-dia)).   

```{r plot-mzb-n-taxa, echo=F, fig.height=5,fig.width=10, fig.cap="Numbers of taxa on each taxonomical level for all typical assemblages.", warning=F}
pg = plot_grid(
  align = 'h',
  gg_mzb_per_level + theme(legend.position = "none"),
  gg_dia_per_level + theme(legend.position = "none") + ylab(""),
  labels = c('A', 'B'),
  ncol = 2
)
pg_leg = get_legend(gg_mzb_per_level + theme(legend.position = "bottom"))
pg = plot_grid(
  pg, 
  pg_leg,
  ncol = 1,
  rel_heights = c(1,.1)
)
pg
```

We can express the uniqueness of a TA with the following score: Each taxon receives a taxon uniqueness score that is one divided by the number of TAs it occurs in. For each river type, we sum the taxon scores of all taxa up and divide it by the number of taxa in the river type’s TA. If all taxa in the TA are unique to that TA the score is one. If all species occur in one other TA the score is 0.5. The minimal score depends on the number of TAs, as it is 1 divided by that number and it signals that all species in that TA occur in all other TAs. These scores are shown in Figure \@ref(fig:plot-uni). The dashed horizontal lines indicate the minimum scores.  


```{r load-uniplot, echo=F, results='hide', warning=FALSE, message=FALSE}
source(file.path(dir_plots, "dia_ta_uniquemess.R"))
source(file.path(dir_plots, "mzb_ta_uniquemess.R"))
```
```{r plot-uni, echo=FALSE, fig.align="center", fig.cap="Uniqueness scores for typical assemblages of macroinvertebrates(A) and diatoms (B). The red dashed line indicates the lowest possible score.", fig.width=10,fig.height=4}
plot_grid(
  align = 'h',
  gg_mzb_uni,
  gg_dia_uni + theme(legend.position = "none"),
  labels = c('A', 'B'),
  ncol = 2
)
```
We used Principal Coordinate Analysis (PCoA, @gower1966some) to visualize the similarity of TAs, based on Jaccard distance matrices (Figure \@ref(fig:pcoa)).

```{r prepare pcoa, echo=F, results='hide', warning=FALSE, message=FALSE}
source(file.path(dir_plots, "mzb_nmds_pcoa.R"))
source(file.path(dir_plots, "dia_nmds_pcoa.R"))
```

```{r pcoa, echo=FALSE, fig.height=5, fig.cap="Principal Coordinate Analysis ordinations of typical assemblages based on Jaccard distance matrices. A shows the typical asseblages of macroinvertebrates and B those of diatoms."}
plot_grid(align='v', 
          plot_mzb_pcoa, 
          plot_dia_pcoa, 
          labels = c('A', 'B'), 
          ncol = 1)
```

The first axis of the macroinvertebrate PCoA separates the TAs into two groups: i) the large cluster 8-11_15_16, RT12, RT14, RT18, RT2_3 and ii) RT4_5 and RT1.
The larger group represents all mid to high-altitude rivers and RT2_3.
The two river types in the smaller group are more distinct than those in the larger but could be identified as low-land rivers in contrast to the first group.
However the cumulative relative eigenvalues of the first two principal components is only a little higher than half, which means that there is considerable variation in the distance matrix that is not displayed in this PCoA.

<!-- Diatoms -->
A similar picture emerges in the PCoA of diatom TAs. 
The large cluster and several other groups are divided from two other types by the first axis. 
However in this case, the group around the large cluster is split into two subgroups along the second axis: small lowland rivers (RT3 and RT5) and the large cluster together with high altitude rivers.
The two river types that are removed from this group are those with influence from histosol soils (RT6 and RT12), whose distinctive assemblages were already mentioned in the analysis of TA redundancy. Online, we provide the taxa lists for all [macroinvertebrate](https://github.com/JonJup/GetReal/blob/master/005_documents/2020_11_report%20after%20pr3/doc/typical_assemblages_invertebrates_taxa_list.pdf) and [diatom](https://github.com/JonJup/GetReal/blob/master/005_documents/2020_11_report%20after%20pr3/doc/typical_assemblages_diatoms_taxa_list.pdf) TAs.

# Seasonal typical assemblages 

In addition to the spatially defined TAs, we derived seasonal TAs (sTA) for a subset of river types. 
The four seasons were defined as follows: spring is March to May, Summer is June to August, Fall is September to November, and Winter is December to February. 
To avoid strong spatial signals in the sTAs, we only considered those river types (RT) in which samples were evenly distributed between seasons. 
In most cases, we had to omit parts of the data (e.g. certain seasons or datasets) to achieve an even spatio-temporal distribution. 
Online, we provide maps for all RT with all available seasons as well as the respective subsets that we used in the further analyses for [macroinvertebrates](https://github.com/JonJup/GetReal/tree/master/002_working_package_02/003_seasonality/004_plots/invertebrates/maps) and [diatoms](https://github.com/JonJup/GetReal/tree/master/002_working_package_02/003_seasonality/004_plots/diatoms/maps).  
As an example, the map of macroinvertebrate samples for the combined RT 4_5 is shown in Figure \@ref(fig:sampling-map2).

```{r sampling-map1, echo=FALSE, results='hide'}
source(file = file.path(dir_plots, "mzb_seasonal_samples_map.R"))
```

```{r sampling-map2, echo=FALSE, fig.cap="Map of sampling sites for the combined River Type 4_5. The color of the points shows the season of sampling.", fig.height=3.5}
season_plot
```

```{r clean-sampling-map, echo=FALSE, results="hide"}
#rm(plot_object, data, mcp_sub, osm, plot_data);gc()
```

To visualize differences between the seasons we used Non-metric multidimensional scaling (NMDS) on Jaccard dissimilarity matrices.
The resulting NMDS plots are available for [macroinvertebrates](https://github.com/JonJup/GetReal/tree/master/002_working_package_02/003_seasonality/004_plots/invertebrates) and [diatoms](https://github.com/JonJup/GetReal/tree/master/002_working_package_02/003_seasonality/004_plots/diatoms/nmds).
Figure \@ref(fig:plot-nmds) shows the NMDS plot for invertebrate samples in RT4_5.
For diatoms and macroinvertebrates there are no or little discernible seasonal patterns in most river types.
This also shows in high NMDS stress values (typically above 0.2).

```{r load-nmds, echo=FALSE}
source("../../plot_scripts/mzb_nmds_seasons.R")
```
```{r plot-nmds, echo=FALSE, fig.cap="Nonmetric multidimensional scaling plot of Jaccard dissimilarity matrices for macroinvertebrate communities in RT4_5. The color of the points shows the season. Convex hulls surround all sampling points from one season.", fig.height=3.5}
gg_mz_nmds_season
```
```{r clean-plot-nmds, echo=FALSE, results="hide"}
#rm(list =ls());gc()
```

Further, we evaluated whether the Jaccard dissimilarity between sites would be better explained by spatial distance or by season.
To this end, we employed generalized dissimilarity modeling (GDM, @Ferrier2007).
In GDMs, the response variable is the ecological dissimilarity between two sites (expressed in some *a priori* chosen dissimilarity metric, here Jaccard).
Smooth functions are fitted to the environmental data and the differences between the values of these functions at the two sites of interest are used as explanatory variables.
By using a generalized modeling framework we can account for the bounded nature of dissimilarity metrics (between 0-1) and the smooth functions allow for variation in the rate of compositional turnover along gradients.
Plots that show the effect of spatial distance and that of season for all GDMs are available for [macroinvertebrates](https://github.com/JonJup/GetReal/tree/master/002_working_package_02/003_seasonality/004_plots/invertebrates/gdm) and [diatoms](https://github.com/JonJup/GetReal/tree/master/002_working_package_02/003_seasonality/004_plots/diatoms/gdm). 
The plot for invertebrates in RT4_5 is shown in Figure \@ref(fig:plot-gdm). 
The findings from the NMDS are confirmed in the GDMs - spatial distance explains more of the variation in jaccard distances than seasons. 

```{r load-gdm, echo=FALSE}
source("~/01_Uni/02_getreal/005_documents/plot_scripts/mzb_gdm.R")
```

```{r plot-gdm, echo=FALSE, fig.cap="Partial ecological distance between sites with increasing geographic distance or chaning season (1 = spring, 2 = summer, 3 = autumn, and 4 = winter) predicted with Generalized Dissimilarity Models", fig.height=3,fig.align="center"}
p3
```


We selected RT2_3 and 8-11_15_16 for invertebrates and RT11 and 15 for diatoms because they showed the strongest effect of season in GDM and NMDS. For these four river types sTA were derived in the same way as the non-seasonal TAs.

# Patterns and overlap in seasonal assemblages
In RT11, the number of diatom taxa in the sTAs did not vary strongly between the seasons (Table \@ref(tab:tbl-sta-overlap-dia-11)).
The summer and autumn sTAs were more similar to each other than either to the winter sTA.
The latter was lightly more similar to the summer sTA (66.7%) than to the autumn sTA (63.6%).

```{r load tbl-sta-overlap-dia, echo=FALSE}
om11 <-readRDS(file.path(dir_sa_dia, "tbl_sta_dia_11.RDS"))
om15 <-readRDS(file.path(dir_sa_dia, "tbl_sta_dia_15.RDS"))
```

```{r tbl-sta-overlap-dia-11, echo=FALSE}
om11 %>%
  kable(caption = "Overlap between seasonal typical assemblages (sTA) of diatoms in river type 11  expressed in percent of taxa in row sTA also present in column sTA. N is the number of taxa in the respective sTA.") %>%
  kable_styling(latex_options = "hold_position")
```

In RT15 similar patterns can be seen:
The number of taxa does not vary strongly between seasons and summar and autumn sTAs are more similar to each other than to the winter sTA. 
The difference between summer and winter sTAs in RT15 is the largest seasonal change we found in the two river types. 

```{r tbl-sta-overlap-dia-15, echo=FALSE}
om15 %>%
  kable(caption = "Overlap between seasonal typical assemblages (sTA) of diatoms in river type 15  expressed in percent of taxa in row sTA also present in column sTA. N is the number of taxa in the respective sTA.") %>%
  kable_styling(latex_options = "hold_position")
```


```{r load tbl-sta-overlap-mzb, echo=FALSE}
om23  <- readRDS(file.path(dir_sa_inv, "seasonal_overlap_RT_2_3.RDS"))
om81 <-readRDS(file.path(dir_sa_inv, "seasonal_overlap_RT_large.RDS"))
```

For the macroinvertebrates, the number of taxa in the sTAs is lower than for diatoms.
In both river types, the number of taxa in the autumn sTA is higher than in other seasons. 
In the combined type RT2_3, the summer sTA is nested in the autumn sTA (Table \@ref(tab:tbl-sta-overlap-mzb-23)).  

```{r tbl-sta-overlap-mzb-23, echo=FALSE}
om23 %>%
  kable(caption = "Overlap between seasonal typical assemblages (sTA) of diatoms in river type 2+3  expressed in percent of taxa in row sTA also present in column sTA. N is the number of taxa in the respective sTA.") %>%
  kable_styling(latex_options = "hold_position")
```

In the other combined river type considered here, RT 8-11_15_16, the sTA sizes are more similar to each other than in RT2_3 and the sTAs are not as similar (Table \@ref(tab:tbl-sta-overlap-mzb-811)).
Spring and summer have a higher overlap with autumn than with each other and autumn has a marginally higher overlap with summer (56.5%) than with spring (52.2%).

```{r tbl-sta-overlap-mzb-811, echo=FALSE}
om81 %>%
  kable(caption = "Overlap between seasonal typical assemblages (sTA) of diatoms in river type 8-11+15+16  expressed in percent of taxa in row sTA also present in column sTA. N is the number of taxa in the respective sTA.") %>%
  kable_styling(latex_options = "hold_position")
```


<!--
Below we explore two patterns in the sTAs: i) the high richness of diatom sTA relativ to macroinvertebrate sTAs, and ii) the high richness of autumn macroinvertebrate sTAs relative to other seasons. 
Two mechanisms could cause the richness of the TA to change with an increasing number of sampling locations.
A decrease in richness could occur because the absolute number of occurrences required to be included in the TA increases with the number of sampling sites.  
In this model, the high number of taxa would be caused by taxa that are only included because of noise. 
The number should decrease if more samples would be taken. 
An increase in TA size with an increasing number of sampling sites could occur because the total impact of atypical sites which might be overrepresented in the sample by happenstance would most certainly decrease. 
Here, atypical refers to the community composition, i.e. taxa that are rare in other sites occur commonly and otherwise frequently occurring taxa are absent.
Similar effects might also account for the difference between diatoms and macroinvertebrates. 
We used OLS to regress the size of typical assemblages against the number of sampling locations (log-transformed) across taxa groups. 
The influence of sample size is positive but can be considered as small and not statistically significant ($\beta$ = 2.20, SE = 2.91, 95% CI [-4.15, 8.55], $std. \beta$ = 0.48, *p* = 0.465, Figure \@ref(fig:fig-test)).  

JUSTIFICATION FOR COMMENTING OUT: The IndVal is explicitly controlling for this. At least in the A component. Not in B though. 



```{r fig-test, echo=F, fig.height=3.5,fig.width=7, fig.cap="Regression of the taxon richness of typical assemblages against the number of sampling locations. Gray shaded area shows the 95% confidence interval for the regression line. The color of the dots indicates the taxon group."}
data<-data.frame(n_samples = c(55,188,103,39, 7,42,27,36, 157,52,13, 82,19,52),
           TA        = c(2,7,17,6,4,3,16,4, 28,21,22, 19,16,29),
           taxon     = c("Macroinvertebrate", "Macroinvertebrate", "Macroinvertebrate", "Macroinvertebrate",
                         "Macroinvertebrate", "Macroinvertebrate", "Macroinvertebrate", "Macroinvertebrate", 
                         "Diatom", "Diatom", "Diatom", "Diatom", "Diatom", "Diatom"))
options(warn = -1)

ggplot(data, aes(x = log(n_samples), y = TA)) + 
        geom_smooth(method='lm', formula= y~x) + 
        geom_point(aes(col = taxon)) +
        ylab("taxon richness of typical assemblage") + 
        xlab("log number of samples")
# mod = lm(
#   TA ~ log(n_samples),
#   data=data
# )
# report::report(mod)
```

The number of sampled communities does not differ strongly between taxa (Table 6). 
Most importantly, the number of macroinvertebrate samples for one river type is lower than that of diatom samples in RT11 and RT15 while the other one is higher. 
Thus, the overall difference in richness can not be explained by the number of sampled communities. 
The mean number of taxa in diatom communities was lower than in macroinvertebrate communities. 
The total number of taxa was also lower for diatoms than for invertebrates. 
This might partly also be due to the extensive harmonization efforts that summarized some diatom species in larger complexes. 
However, it also highlights that there is less variation between sites within river types, which is conductive to larger TA. 
Strong turnover between sites within one river type or season leads to low average fidelity (B value) and consequently to few taxa in the typical assemblages.   

```{r tbl-summary-stats, echo=F}
data <- data.table("Class" = rep(c("Invertebrates", "Diatoms"), each=2), 
                   "RT" = paste0("RT", c("10_11", "15_16", "11", "15")),
                   "N samples" = c(385, 112, 265, 230),
                   "mean richness" = c(32.7, 22.9, 23.3, 17.1),
                   #"Median richness"= c(32, 23, 22.5, 16),
                   "SD richness" = c(11.7, 9.3, 7.1, 6.5),
                   "N taxa"=c(257, 113, 140, 99),
                   "Samples per Season"=c("55/188/103/39", "7/42/27/36", "0/157/52/13", "0/82/19/52")
)
data %>% 
  kable(caption=
"Summary statistics of samples used to delineate seasonal typical assemblages.Rt is the river type. N samples is the total number of samples taken in the respecitve river type. Mean richness is the mean number of taxa found at a sampling event. Medians are not shown but do not deviate strongly from means. SD richness is the standard deviation of taxa richness and N taxa the total number of taxa found in a river type.In the last column \"Samples per Season\" the seasons go from spring to winter.", 
        format="latex") %>% 
  kable_styling(font_size = 11)
                                       
```
-->

Online, we provide the complete taxa lists for [macroinvertebrate](https://github.com/JonJup/GetReal/blob/master/005_documents/2020_11_report%20after%20pr3/doc/seasonal_typical_assemblages_invertebrates_taxa_list.pdf) and [diatom](https://github.com/JonJup/GetReal/blob/master/005_documents/2020_11_report%20after%20pr3/doc/seasonal_typical_assemblages_diatoms_taxa_list.pdf) sTAs.

\newpage

# References
